name: Twitter Bot Automation

on:
  schedule:
    # Fetch news at 9:00, 15:00, 18:00 IST → GitHub Actions uses UTC (IST - 5:30)
    - cron: '03 3,9,12 * * *'  # 9:00, 15:00, 18:00 IST in UTC
    # Post tweets hourly 10:00 → 01:00 IST
    - cron: '30 4-19 * * *'    # 10:00 → 01:00 IST in UTC
  workflow_dispatch:  # allows manual trigger

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install tweepy requests beautifulsoup4 googletrans==4.0.0-rc1

    - name: Set environment variables
      run: |
        echo "API_KEY=${{ secrets.API_KEY }}" >> $GITHUB_ENV
        echo "API_SECRET=${{ secrets.API_SECRET }}" >> $GITHUB_ENV
        echo "ACCESS_TOKEN=${{ secrets.ACCESS_TOKEN }}" >> $GITHUB_ENV
        echo "ACCESS_SECRET=${{ secrets.ACCESS_SECRET }}" >> $GITHUB_ENV

    - name: Run Script
      run: |
        # Determine which script to run based on hour
        HOUR_UTC=$(date -u +"%H")
        # Fetch news times: 3, 9, 12 UTC → 9, 15, 18 IST
        if [[ "$HOUR_UTC" == "03" || "$HOUR_UTC" == "09" || "$HOUR_UTC" == "12" ]]; then
            echo "[INFO] Running fetch_news.py"
            python fetch_news.py
        else
            echo "[INFO] Running post_tweets.py with random delay"
            # Random delay ±10 min (0-20 min) before posting
            DELAY=$(( RANDOM % 20 ))
            echo "Sleeping for $DELAY minutes..."
            sleep ${DELAY}m
            python post_tweets.py
        fi
